<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant d'Entretien</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="icon-16.png" sizes="16x16">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, textarea { font-size: 16px !important; }
        body { margin: 0; padding: 0; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Définition des composants et fonctions utilitaires ---
        const Bell = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="m13.73 21a2 2 0 0 1-3.46 0"/></svg>);
        const Plus = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14m-7-7v14"/></svg>);
        const ArrowLeft = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const Wrench = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>);
        const Car = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18.4 10c-.4-.8-1.2-1.3-2.1-1.3H7.7c-.9 0-1.7.5-2.1 1.3L3.5 11.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>);
        const Flower = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9a3 3 0 0 0 3 3h1.5M12 7.5V9a3 3 0 0 1-3 3H7.5"/><path d="M12 16.5V21"/><path d="M8 18h8"/></svg>);
        const HomeIcon = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const HistoryIcon = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 8v4l3 3"/><path d="M22 12c0 2.76-2.24 5-5 5H4.27a2 2 0 0 1-1.27-.42L.5 14.5M2 12C2 9.24 4.24 7 7 7h12.73a2 2 0 0 1 1.27.42L23.5 9.5"/></svg>);
        const CheckCircle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>);
        const Clock = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>);
        const AlertTriangle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="m12 17.02.01 0"/></svg>);
        const Edit = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>);
        const Trash2 = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>);
        const CalendarClock = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="M18 14a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/><path d="M18 16.5V18"/></svg>);
        const Sun = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const Moon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
        const Search = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;

        const categories = {
            voiture: { icon: Car, label: 'Voiture', bgClass: 'bg-green-100 dark:bg-green-900/50' },
            electromenager: { icon: Wrench, label: 'Électroménager', bgClass: 'bg-blue-100 dark:bg-blue-900/50' },
            maison: { icon: HomeIcon, label: 'Maison', bgClass: 'bg-purple-100 dark:bg-purple-900/50' },
            jardin: { icon: Flower, label: 'Jardin', bgClass: 'bg-emerald-100 dark:bg-emerald-900/50' },
            cuisine: { icon: Utensils, label: 'Cuisine', bgClass: 'bg-pink-100 dark:bg-pink-900/50' },
            sdb: { icon: Bath, label: 'Salle de bain', bgClass: 'bg-cyan-100 dark:bg-cyan-900/50' },
            chambre: { icon: Bed, label: 'Chambre', bgClass: 'bg-indigo-100 dark:bg-indigo-900/50' },
            autres: { icon: Bell, label: 'Autres', bgClass: 'bg-gray-200 dark:bg-gray-700' },
        };
        
        const getStatus = (nextDateStr) => { /* ... (code inchangé) ... */ };
        const getStatusColorClasses = (status) => { /* ... (code inchangé) ... */ };
        const getStatusText = (status, nextDate) => { /* ... (code inchangé) ... */ };
        
        const Header = ({ currentView, setCurrentView, isDarkMode, toggleDarkMode, setShowClearHistoryConfirm }) => { /* ... (code inchangé) ... */ };
        const UrgentBanner = ({ count }) => { /* ... (code inchangé) ... */ };
        const DeleteConfirmModal = ({ item, onCancel, onDelete }) => { /* ... (code inchangé) ... */ };
        const ClearHistoryConfirmModal = ({ onCancel, onConfirm }) => { /* ... (code inchangé) ... */ };
        const Footer = ({ currentView, setCurrentView }) => { /* ... (code inchangé) ... */ };
        
        const SearchBar = ({ query, setQuery }) => (
            <div className="relative mb-4">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search className="text-gray-400"/></div>
                <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Rechercher un élément..." className="w-full pl-10 pr-4 py-3 border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500"/>
            </div>
        );

        const ItemCard = ({ item, startEdit, setShowDeleteConfirm, justCompleted, markAsDone, showDetails }) => {
            const category = categories[item.category] || categories.autres;
            const status = getStatus(item.nextMaintenance);
            const [textColor, bgColor, borderColor] = getStatusColorClasses(status).split(" ");
            
            return (
                <div className={`bg-white dark:bg-gray-800 rounded-lg shadow-md border-l-4 ${borderColor} ${justCompleted === item.id ? 'ring-2 ring-green-500' : ''}`}>
                    <div onClick={() => showDetails(item)} className="p-4 cursor-pointer">
                        <div className="flex items-start justify-between mb-3">
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                <div className={`p-2 rounded-lg ${category.bgClass}`}><category.icon className="dark:text-gray-200" /></div>
                                <div className="dark:text-gray-200"><h3 className="font-semibold">{item.name}</h3><p className="text-sm text-gray-500 dark:text-gray-400">{category.label}</p></div>
                            </div>
                            <div className="flex gap-1 ml-2">
                                <button onClick={(e) => { e.stopPropagation(); startEdit(item); }} className="p-2 text-gray-400 hover:text-blue-500 rounded-lg"><Edit /></button>
                                <button onClick={(e) => { e.stopPropagation(); setShowDeleteConfirm(item.id); }} className="p-2 text-gray-400 hover:text-red-500 rounded-lg"><Trash2 /></button>
                            </div>
                        </div>
                        <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium mb-3 border ${borderColor.replace('border-','border-')} ${bgColor} ${textColor}`}>
                            {status === 'overdue' ? <AlertTriangle className="w-4 h-4"/> : <Clock className="w-4 h-4"/>}
                            {getStatusText(status, item.nextMaintenance)}
                        </div>
                        <div className="space-y-1 text-sm text-gray-600 dark:text-gray-300">
                            <p><span className="font-medium">Dernier:</span> {new Date(item.lastMaintenance).toLocaleDateString('fr-FR')}</p>
                            <p><span className="font-medium">Prochain:</span> {new Date(item.nextMaintenance).toLocaleDateString('fr-FR')}</p>
                        </div>
                    </div>
                    <div className="border-t dark:border-gray-700 p-2">
                         <button onClick={() => markAsDone(item.id)} className={`w-full px-4 py-3 rounded-lg flex items-center justify-center gap-2 font-medium transition-colors ${justCompleted === item.id ? 'bg-green-700 text-white' : 'bg-green-600 text-white hover:bg-green-700'}`} disabled={justCompleted === item.id}>
                            <CheckCircle />{justCompleted === item.id ? 'Terminé !' : 'Marquer comme fait'}
                        </button>
                    </div>
                </div>
            );
        };
        
        const HistoryCard = ({ item }) => { /* ... (code inchangé) ... */ };
        const ItemForm = ({ onSubmit, itemState, setItemState, title, buttonText }) => { /* ... (code inchangé) ... */ };
        const FilterView = ({ filter, setFilter, setCurrentView }) => { /* ... (code inchangé) ... */ };
        
        const DetailsView = ({ item, history, setCurrentView }) => {
            const itemHistory = history.filter(h => h.originalId === item.id).sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt));
            const category = categories[item.category] || categories.autres;
            return (
                <div className="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-lg shadow-lg p-6 animate-fade-in">
                    <div className="flex items-center gap-4 mb-4 pb-4 border-b dark:border-gray-700">
                        <div className={`p-3 rounded-lg ${category.bgClass}`}><category.icon className="dark:text-gray-200" /></div>
                        <div>
                            <h2 className="text-2xl font-bold ">{item.name}</h2>
                            <p className="text-gray-500 dark:text-gray-400">{category.label}</p>
                        </div>
                    </div>
                    <div className="space-y-2 text-sm mb-6">
                        <p><strong>Prochain entretien :</strong> {new Date(item.nextMaintenance).toLocaleDateString('fr-FR')}</p>
                        <p><strong>Dernier entretien :</strong> {new Date(item.lastMaintenance).toLocaleDateString('fr-FR')}</p>
                        <p><strong>Fréquence :</strong> Tous les {item.intervalDays} jours</p>
                        {item.notes && <p className="mt-2 pt-2 border-t dark:border-gray-700"><strong>Notes :</strong> {item.notes}</p>}
                    </div>

                    <h3 className="text-xl font-semibold mt-6 mb-3">Historique d'entretien</h3>
                    {itemHistory.length > 0 ? (
                        <ul className="space-y-2">
                            {itemHistory.map(h => (
                                <li key={h.id} className="flex justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                    <span>Fait le :</span>
                                    <span className="font-medium">{new Date(h.completedAt).toLocaleString('fr-FR', {dateStyle: 'long', timeStyle: 'short'})}</span>
                                </li>
                            ))}
                        </ul>
                    ) : <p className="text-gray-500 dark:text-gray-400 italic">Aucun historique pour cet élément.</p>}
                </div>
            );
        };
        
        const PageView = ({ items, view, ...props }) => { /* ... (code inchangé) ... */ };
        
        const AppUI = ({
            items, history, currentView, setCurrentView, detailedItem, showDetails,
            newItem, setNewItem, editingItem, setEditingItem, justCompleted,
            showDeleteConfirm, setShowDeleteConfirm, showClearHistoryConfirm, setShowClearHistoryConfirm, 
            addItem, startEdit, saveEdit, markAsDone, deleteItem, clearHistory,
            searchQuery, setSearchQuery, isDarkMode, toggleDarkMode
        }) => { /* ... (code inchangé, avec les nouvelles props) ... */ };
        
        // --- Composant principal de l'application ---
        const MobileMaintenanceApp = () => {
            const [items, setItems] = useState(() => JSON.parse(localStorage.getItem('maintenanceItems_v2')) || []);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('maintenanceHistory_v2')) || []);
            const [currentView, setCurrentView] = useState('today');
            const [detailedItem, setDetailedItem] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [justCompleted, setJustCompleted] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
            const [showClearHistoryConfirm, setShowClearHistoryConfirm] = useState(false);
            const [newItem, setNewItem] = useState({ name: '', category: 'voiture', lastMaintenance: '', intervalDays: '', notes: '' });
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('darkMode') === 'true');
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => { localStorage.setItem('maintenanceItems_v2', JSON.stringify(items)); }, [items]);
            useEffect(() => { localStorage.setItem('maintenanceHistory_v2', JSON.stringify(history)); }, [history]);
            useEffect(() => {
                localStorage.setItem('darkMode', isDarkMode);
                if (isDarkMode) { document.documentElement.classList.add('dark'); } 
                else { document.documentElement.classList.remove('dark'); }
            }, [isDarkMode]);

            const toggleDarkMode = () => setIsDarkMode(!isDarkMode);
            const getNextMaintenanceDate = (lastDate, intervalDays) => { /* ... (code inchangé) ... */ };
            const markAsDone = (id) => { /* ... (code inchangé) ... */ };
            const addItem = () => { /* ... (code inchangé) ... */ };
            const startEdit = (item) => { setEditingItem({ ...item, lastMaintenance: new Date(item.lastMaintenance).toISOString().split('T')[0] }); setCurrentView('edit'); };
            const saveEdit = () => { /* ... (code inchangé) ... */ };
            const deleteItem = (id) => { /* ... (code inchangé) ... */ };
            const clearHistory = () => { setHistory([]); setShowClearHistoryConfirm(false); };
            const showDetails = (item) => { setDetailedItem(item); setCurrentView('details'); };

            return (
                <AppUI
                    items={items} history={history} currentView={currentView} setCurrentView={setCurrentView} detailedItem={detailedItem} showDetails={showDetails}
                    newItem={newItem} setNewItem={setNewItem} editingItem={editingItem} setEditingItem={setEditingItem}
                    justCompleted={justCompleted} showDeleteConfirm={showDeleteConfirm} setShowDeleteConfirm={setShowDeleteConfirm}
                    showClearHistoryConfirm={showClearHistoryConfirm} setShowClearHistoryConfirm={setShowClearHistoryConfirm}
                    addItem={addItem} startEdit={startEdit} saveEdit={saveEdit} markAsDone={markAsDone} deleteItem={deleteItem}
                    clearHistory={clearHistory} searchQuery={searchQuery} setSearchQuery={setSearchQuery}
                    isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode}
                />
            );
        };

        ReactDOM.render(<MobileMaintenanceApp />, document.getElementById('root'));

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.log(`SW Error: ${err}`)); }); }
    </script>
</body>
</html>
